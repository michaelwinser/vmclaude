# Lima VM template for Claude Code development
# Usage: ./vm create   (or: limactl start claude-dev.yaml)
#        ./vm shell    (or: limactl shell claude-dev)

# VM Configuration
vmType: null  # Uses VZ on macOS 13.5+, QEMU otherwise
arch: null    # Matches host architecture

# Resources
cpus: 4
memory: "8GiB"
disk: "64GiB"

# Ubuntu 24.04 LTS cloud images
images:
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img"
    arch: "x86_64"
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
    arch: "aarch64"

# File sharing - mount home directory read-only, projects writable
mounts:
  - location: "~"
    writable: false
  - location: "~/projects"
    writable: true
  - location: "~/.vmclaude-cache"
    writable: true
  - location: "/tmp/lima"
    writable: true

# Containerd (for nerdctl) - disable since we're using Docker/Podman
containerd:
  system: false
  user: false

# Port forwarding - common development ports
portForwards:
  - guestPortRange: [3000, 3010]
    hostPortRange: [3000, 3010]
  - guestPortRange: [4000, 4010]
    hostPortRange: [4000, 4010]
  - guestPortRange: [5000, 5010]
    hostPortRange: [5000, 5010]
  - guestPortRange: [8000, 8010]
    hostPortRange: [8000, 8010]
  - guestPortRange: [8080, 8090]
    hostPortRange: [8080, 8090]

# ===========================================================================
# Phase 1: cloud-init provisioning (fast, idempotent system setup)
# Language runtimes are installed in Phase 2 via: ./vm setup
# ===========================================================================
provision:
  # ---- System-level setup (runs as root) ----
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail

      SENTINEL="/var/lib/vmclaude-system-provisioned"
      if [ -f "$SENTINEL" ]; then
        echo "=== System already provisioned, skipping ==="
        exit 0
      fi

      echo "=== Installing Base Developer Tools ==="
      export DEBIAN_FRONTEND=noninteractive
      apt-get update
      apt-get install -y \
        build-essential gcc g++ make cmake autoconf automake libtool pkg-config \
        git curl wget jq ripgrep fd-find tree htop tmux vim unzip zip \
        ca-certificates gnupg lsb-release software-properties-common apt-transport-https

      # Symlink fd
      ln -sf /usr/bin/fdfind /usr/local/bin/fd

      echo "=== Installing Docker ==="
      install -m 0755 -d /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
        | gpg --batch --yes --dearmor -o /etc/apt/keyrings/docker.gpg
      chmod a+r /etc/apt/keyrings/docker.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" \
        | tee /etc/apt/sources.list.d/docker.list > /dev/null
      apt-get update
      apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
      # Add all regular users to docker group
      getent passwd | awk -F: '$3 >= 1000 && $7 ~ /(bash|zsh|sh)$/ {print $1}' | while read -r user; do
        usermod -aG docker "$user" || true
      done
      systemctl enable docker
      systemctl start docker

      echo "=== Installing Podman ==="
      apt-get install -y podman podman-compose
      mkdir -p /etc/containers
      cat > /etc/containers/registries.conf << 'REGEOF'
      [registries.search]
      registries = ['docker.io', 'quay.io', 'ghcr.io']
      REGEOF

      echo "=== Installing Python ==="
      apt-get install -y python3-pip python3-venv python-is-python3 pipx

      echo "=== Installing Language Build Dependencies ==="
      apt-get install -y \
        libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev \
        libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev libffi-dev \
        liblzma-dev libyaml-dev libncurses5-dev libgdbm-dev

      echo "=== Installing Go ==="
      GO_VERSION="1.22.0"
      ARCH=$(dpkg --print-architecture)
      wget -q "https://go.dev/dl/go${GO_VERSION}.linux-${ARCH}.tar.gz" -O /tmp/go.tar.gz
      rm -rf /usr/local/go
      tar -C /usr/local -xzf /tmp/go.tar.gz
      rm /tmp/go.tar.gz

      echo "=== Installing GitHub CLI ==="
      curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
        | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg 2>/dev/null
      chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
        | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
      apt-get update
      apt-get install -y gh

      echo "=== Installing Google Cloud CLI ==="
      curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg \
        | gpg --batch --yes --dearmor -o /usr/share/keyrings/cloud.google.gpg
      echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" \
        | tee /etc/apt/sources.list.d/google-cloud-sdk.list > /dev/null
      apt-get update
      apt-get install -y google-cloud-cli

      touch "$SENTINEL"
      echo "=== System provisioning complete ==="

  # ---- User-level setup (runs as lima user) ----
  - mode: user
    script: |
      #!/bin/bash
      set -ex -o pipefail

      # .bashrc: only append once (use marker comment)
      MARKER="# --- vmclaude-env-begin ---"
      if ! grep -qF "$MARKER" ~/.bashrc 2>/dev/null; then
        cat >> ~/.bashrc << 'BASHEOF'

      # --- vmclaude-env-begin ---
      # Claude Code Development Environment (managed by vmclaude)

      # Base tools
      export PATH="$HOME/.local/bin:$PATH"
      alias fd='fdfind'
      alias ll='ls -alF'
      alias dc='docker compose'
      alias pc='podman-compose'

      # nvm (guarded)
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
      [ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"

      # Rust (guarded)
      [ -f "$HOME/.cargo/env" ] && . "$HOME/.cargo/env"

      # Go
      export PATH=$PATH:/usr/local/go/bin
      export GOPATH=$HOME/go
      export PATH=$PATH:$GOPATH/bin

      # rbenv (guarded)
      [[ -d $HOME/.rbenv/bin ]] && export PATH="$HOME/.rbenv/bin:$PATH"
      command -v rbenv >/dev/null && eval "$(rbenv init -)"

      # Package manager caches (pointed at persistent host mount)
      VMCACHE="$HOME/.vmclaude-cache"
      if [ -d "$VMCACHE" ]; then
        export PIP_CACHE_DIR="$VMCACHE/pip"
        export POETRY_CACHE_DIR="$VMCACHE/poetry"
        export npm_config_cache="$VMCACHE/npm"
        export PNPM_STORE_DIR="$VMCACHE/pnpm"
        export GOMODCACHE="$VMCACHE/go/mod"
        export GOCACHE="$VMCACHE/go/build"
      fi

      # Claude Code — dangerous mode by default (this VM is purpose-built for it)
      claude() { command claude --dangerously-skip-permissions "$@"; }
      # --- vmclaude-env-end ---
      BASHEOF
        echo "=== .bashrc configured ==="
      else
        echo "=== .bashrc already configured, skipping ==="
      fi

      # Directories
      mkdir -p ~/go/{bin,src,pkg}
      mkdir -p ~/projects
      mkdir -p ~/.vmclaude

      # Cargo cache symlinks (Cargo doesn't support a cache-only env var)
      if [ -d "$HOME/.vmclaude-cache/cargo" ]; then
        mkdir -p "$HOME/.cargo"
        for d in registry git; do
          if [ -d "$HOME/.vmclaude-cache/cargo/$d" ] && [ ! -L "$HOME/.cargo/$d" ]; then
            rm -rf "$HOME/.cargo/$d"
            ln -s "$HOME/.vmclaude-cache/cargo/$d" "$HOME/.cargo/$d"
          fi
        done
      fi

      # Claude Code settings (overwrite-safe — always set canonical permissions)
      mkdir -p ~/.claude
      cat > ~/.claude/settings.json << 'SETTINGSEOF'
      {
        "permissions": {
          "allow": [
            "Bash(*)",
            "Read(*)",
            "Write(*)",
            "Edit(*)",
            "Glob(*)",
            "Grep(*)",
            "WebFetch(*)",
            "WebSearch(*)",
            "NotebookEdit(*)",
            "Task(*)"
          ],
          "deny": []
        }
      }
      SETTINGSEOF

      # CLAUDE.md (overwrite-safe — always set canonical rules)
      cat > ~/CLAUDE.md << 'CLAUDEMDEOF'
      # Development Environment Rules

      ## Isolation Requirements (MANDATORY)

      ### Python
      - **Always use poetry**: `poetry init` then `poetry add <package>`
      - Never `pip install` directly — use `poetry add` instead

      ### Node.js
      - Use project-local `node_modules`
      - Prefer `pnpm` over `npm`

      ### Go
      - Use Go modules: `go mod init <module-name>`

      ### Rust
      - Use Cargo: `cargo init` or `cargo new`

      ### Ruby
      - Use Bundler: `bundle init`

      ## Container-First Development
      - Use `docker compose` or `podman-compose` for multi-service setups
      - Build artifacts inside containers for reproducibility

      ## What NOT To Do
      - Never `pip install` directly — use `poetry add`
      - Never `npm install -g` for project dependencies
      - Never install language runtimes globally (use version managers)
      CLAUDEMDEOF

      echo "=== User provisioning complete ==="
